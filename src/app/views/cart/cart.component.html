<div class="flex-column container">
  @if (_cartService.items$.value.length <= 0 && currentTab !== "success") {
    <h4>No hay productos en el carrito</h4>
    <app-button
      fontSize="font-xl"
      (onClick)="router.navigate(['/tienda'])"
    >
      Ir a la tienda
    </app-button>
  } @else {
    <div class="flex-row">
      <div 
        class="flex-row cursor-pointer nav-item"
        [ngClass]="{'active': currentTab === 'cart'}"
        (click)="changeTab('cart')"
      >
        <div class="item flex-row" [ngClass]="{'active': currentTab === 'cart'}">1</div>
        <p class="name">CARRITO</p>
      </div>
      <mat-icon class="taupe" style="font-weight: 800;">chevron_right</mat-icon>
      <div 
        class="flex-row cursor-pointer nav-item"
        [ngClass]="{'active': currentTab === 'checkout'}"
        (click)="changeTab('checkout')"
      >
        <div class="item flex-row" [ngClass]="{'active': currentTab === 'checkout'}">2</div>
        <p class="name">DETALLES DEL PEDIDO</p>
      </div>
      <mat-icon class="taupe" style="font-weight: 800;">chevron_right</mat-icon>
      <div 
        class="flex-row cursor-pointer nav-item"
        [ngClass]="{'active': currentTab === 'success'}"
      >
        <div class="item flex-row" [ngClass]="{'active': currentTab === 'success'}">3</div>
        <p class="name">PEDIDO COMPLETADO</p>
      </div>
    </div>
    <div class="flex-row" style="width: 100%; align-items: flex-start; gap: 2rem;">
      @if (currentTab === "cart") {
        <section class="main-section flex-column">
          <table>
            <thead>
              <tr>
                <th>
                  <p class="header-title">PRODUCTO</p>
                </th>
                <th>
                  <p class="header-title">PRECIO</p>
                </th>
                <th>
                  <p class="header-title">CANTIDAD</p>
                </th>
                <th>
                  <p class="header-title">SUBTOTAL</p>
                </th>
              </tr>
            </thead>
            <tbody>
              @for (product of _cartService.items$.value; track $index) {
                <tr app-product-item
                  [product]="product"
                ></tr>
              }
            </tbody>
          </table>
          <div class="flex-row">
            <app-button
              fontSize="font-xl"
              (onClick)="router.navigate(['/tienda'])"
            >
              Seguir comprando
            </app-button>
            <app-button
              fontSize="font-xl"
              theme="secondary"
              (onClick)="_cartService.clearCart()"
            >
              Vaciar carrito
            </app-button>
          </div>
        </section>
        <section class="secondary-section flex-column">
          <p class="header-title">RESUMEN DEL PEDIDO</p>
          <hr class="line" />
          <section class="flex-column" style="width: 100%; gap: 0.25rem;">
            <div class="flex-row full-row">
              <p class="header-title">SUBTOTAL</p>
              <p class="text">S/. {{totalWithoutIGV.toFixed(2)}}</p>
            </div>
            <div class="flex-row full-row">
              <p class="header-title">IGV (18%)</p>
              <p class="text">S/. {{igv.toFixed(2)}}</p>
            </div>
            <div class="flex-row full-row">
              <p class="header-title">TOTAL</p>
              <p class="discount-price">S/. {{totalCart.toFixed(2)}}</p>
            </div>
          </section>
          <hr class="line" />
          <app-button
            [fullSize]="true"
            (onClick)="changeTab('checkout')"
          >
            Finalizar compra
          </app-button>
        </section>
      }@else if (currentTab === "checkout") {
        <section class="main-section flex-column" style="position: sticky;" [ngStyle]="{'top': _dataService.isInfoNavbarVisible ? '180px' : '150px'}">
          <div class="main-card border-type1">
            <div class="flex-row">
              <mat-icon>forklift</mat-icon>
              <h4 class="name">Tipo de entrega</h4>
            </div>
            <app-shipping-card
              [options]="shippingOptions"
              (selected)="onShipChange($event)"
            />
          </div>
          @if (shipType$.value === "ENVIO_AGENCIA") {
            <div class="main-card border-type1">
              <div class="flex-row">
                <mat-icon>local_shipping</mat-icon>
                <h4 class="name">Datos de envío</h4>
              </div>
              <form class="form" [formGroup]="agencyForm">
                <section class="input-section">
                  <app-select 
                    formControlName="department"
                    id="department"
                    [options]="departmentOptions"
                    label="Departamento"
                    [error]="errorMessage(agencyForm, 'department', {})"
                  />
                  <app-select
                    formControlName="city"
                    id="city"
                    [options]="provinceOptions"
                    [isDisabled]="currentDep <= 0"
                    label="Ciudad"
                    [error]="errorMessage(agencyForm, 'city', {})"
                  />
                </section>
                <custom-input
                  formControlName="fullName"
                  id="fullName"
                  label="Nombre completo"
                  placeholder="ej. Jhon Doe"
                  [error]="errorMessage(agencyForm, 'fullName', {})"
                />
                <section class="input-section">
                  <custom-input
                    formControlName="dni"
                    id="dni"
                    placeholder="ej. 12345678"
                    label="DNI"
                    [error]="errorMessage(agencyForm, 'dni', {minlength: 8, maxlength: 8})"
                  />
                  <custom-input
                    formControlName="phone"
                    id="phone"
                    placeholder="ej. 912345678"
                    label="Teléfono"
                    [error]="errorMessage(agencyForm, 'phone', {minlength: 9, maxlength: 9})"
                  />
                </section>
              </form>
            </div>
          }@else if(shipType$.value === "RECOJO_ALMACEN") {
            <div class="main-card border-type1">
              <div class="flex-row">
                <mat-icon>edit_calendar</mat-icon>
                <h4 class="name">Programar recojo</h4>
              </div>
              <div class="warehouse-card">
                <div class="flex-row">
                  <mat-icon 
                    class="dim"
                    style="font-size: 1.5rem"
                  >
                    location_on
                  </mat-icon>
                  <h5 class="warehouse-title dim">Almacen {{warehouseSelected?.name}}</h5>
                </div>
                <div 
                  class="flex-column"
                  style="gap: 0.2rem; width: 100%;"
                >
                  <p class="warehouse-text">{{warehouseSelected?.address}}</p>
                  <div class="flex-row" style="width: 100%; justify-content: space-between">
                    <p class="warehouse-text">Horario: Lunes a Sábado 8:00 AM - 6:00 PM</p>
                    <app-button
                      theme="secondary"
                      fontSize="font-md"
                      (onClick)="showMapDialog()"
                    >
                      Ver en mapa
                    </app-button>
                  </div>
                </div>
              </div>
              <form class="form" [formGroup]="warehouseForm">
                <section class="input-section">
                  <custom-input
                    type="date"
                    formControlName="date"
                    id="date"
                    [min]="minDate"
                    label="Fecha"
                    placeholder="Seleccione una fecha"
                    [error]="errorMessage(warehouseForm, 'date', {})"
                  />
                  <app-select 
                    formControlName="time"
                    id="time"
                    [options]="availableHours"
                    label="Hora"
                    [error]="errorMessage(warehouseForm, 'time', {})"
                    placeholder="Seleccione una hora"
                    [isDisabled]="!warehouseForm.get('time')?.enabled"
                  />
                </section>
              </form>
            </div>
          }
          <div class="main-card border-type1">
            <div class="flex-row" style="width: 100%; justify-content: space-between">
              <div class="flex-row">
                <mat-icon>article</mat-icon>
                <h4 class="name">Datos de factura</h4>
              </div>
              <div class="flex-row cursor-pointer" (click)="updateInvoiceDetail = !updateInvoiceDetail">
                <input
                  type="checkbox"
                  [checked]="updateInvoiceDetail"
                />
                <p class="text">¿Actualizar datos de factura?</p>
              </div>
            </div>
            <form class="form" [formGroup]="invoiceDetailForm">
              <section class="input-section">
                <app-select
                  formControlName="invoicePreference"
                  id="invoicePreference"
                  label="Tipo de comprobante"
                  [options]="[{id: 'BOLETA', content: 'BOLETA'}, {id: 'FACTURA', content: 'FACTURA'}]"
                  [error]="errorMessage(invoiceDetailForm, 'invoicePreference', {})"
                  [isDisabled]="!updateInvoiceDetail"
                />
                <app-select
                  formControlName="documentType"
                  id="documentType"
                  label="Tipo documento"
                  [options]="[{id: 'DNI', content: 'DNI'}, {id: 'RUC', content: 'RUC'}]"
                  [error]="errorMessage(invoiceDetailForm, 'documentType', {})"
                  [isDisabled]="!updateInvoiceDetail || !invoicePreference || disableDocumentType"
                />
              </section>
              <section class="input-section">
                <div 
                  (click)="isInitialLoad = false"
                  style="width: 100%;"
                >
                  <custom-input
                    formControlName="document"
                    id="document"
                    [isDisabled]="!updateInvoiceDetail || !documentType"
                    [placeholder]="'Ingresa tu ' + (documentType ? documentType : 'documento')"
                    [label]="documentType ? documentType : 'Documento'"
                    [error]="errorMessage(invoiceDetailForm, 'document', {minlength: documentType === 'DNI' ? 8 : 11 })"
                  />
                </div>
                <custom-input
                  formControlName="rsocial"
                  id="rsocial"
                  label="Razón social"
                  [isDisabled]="!updateInvoiceDetail || isDocLoaded || !documentType"
                  placeholder="ej. Jhon Doe"
                  [error]="errorMessage(invoiceDetailForm, 'rsocial', {})"
                />
              </section>
              <custom-input 
                id="address"
                formControlName="address"
                placeholder="Ingresa tu dirección de facturación"
                label="Dirección"
                [error]="errorMessage(invoiceDetailForm, 'address', {})"
                [isDisabled]="!updateInvoiceDetail"
              />
            </form>
          </div>
        </section>
        <section class="secondary-section" style="position: sticky;" [ngStyle]="{'top': _dataService.isInfoNavbarVisible ? '160px' : '130px'}">
          <div class="order flex-column border-type1">
            <h5 class="order-title">RESUMEN DE TU PEDIDO</h5>
            <div class="flex-row full-row">
              <p class="header-title">PRODUCTO</p>
              <p class="header-title">SUBTOTAL</p>
            </div>
            <hr class="line" />
            @for (product of _cartService.items$.value; track $index) {
              <div class="flex-row full-row">
                <p class="text"><span class="taupe">{{product.name}}</span> x{{product.quantity}}</p>
                <p class="discount-price">S/. {{((product.discountPrice ?? product.price) * product.quantity).toFixed(2)}}</p>
              </div>
            }
            <hr class="line" />
            <section class="flex-column" style="width: 100%; gap: 0.25rem;">
              <div class="flex-row full-row">
                <p class="header-title">SUBTOTAL</p>
                <p class="text">S/. {{totalWithoutIGV.toFixed(2)}}</p>
              </div>
              <div class="flex-row full-row">
                <p class="header-title">IGV (18%)</p>
                <p class="text">S/. {{igv.toFixed(2)}}</p>
              </div>
              <div class="flex-row full-row">
                <p class="header-title">TOTAL</p>
                <p class="discount-price">S/. {{totalCart.toFixed(2)}}</p>
              </div>
            </section>
            <hr class="line" />
            <p class="header-title">PAGAR CON TARJETA</p>
            <app-payment 
              (onPay)="onPay($event)"
              [invoiceDetailForm]="invoiceDetailForm"
              [updateInvoiceDetail]="updateInvoiceDetail"
              [pickupForm]="warehouseForm"
              [agencyForm]="agencyForm"
              [documentType]="documentType ?? 'DNI'"
              [shipType]="shipType$.value || 'RECOJO_ALMACEN'"
              [clientId]="clientLogged?.id"
              [currentTab]="currentTab"
              [warehouseId]="shipType$.value === 'RECOJO_ALMACEN' ? (warehouseSelected?.id || 0) : null"
              [isValid]="invoiceDetailForm.valid && (shipType$.value === 'RECOJO_ALMACEN' ? warehouseForm.valid : agencyForm.valid)"
              [clientAddress]="clientAddress"
              [invoiceDetailId]="clientLogged?.invoiceDetail?.id"
            />
          </div>
        </section>
      } @else if (currentTab === "success") {
        <div class="success-card border-type1">
          <div class="success-icon">
            <span class="material-icons">check_circle</span>
          </div>
          <h2 class="success-title">¡Pedido Confirmado!</h2>
          <p class="success-message">Tu pedido se ha generado correctamente</p>
          
          <div class="delivery-info flex-column">
            <div class="flex-row info-item">
              <span class="material-icons">local_shipping</span>
              <p>Entrega en 1-3 días hábiles</p>
            </div>
            <div class="flex-row info-item">
              <span class="material-icons">
                visibility
              </span>
              <p>
                Revisa el detalle de tu pedido en nuestra plataforma
              </p>
            </div>
          </div>
          <div class="flex-row">
            <app-button
              [icon]="'visibility'"
              fontSize="font-xl"
              (onClick)="onOrderDetail()"
            >
              Ver detalle
            </app-button>
            <app-button 
              (onClick)="router.navigate(['/tienda'])"
              fontSize="font-xl"
              theme="secondary"
            >
              Seguir comprando
            </app-button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Diálogo del Mapa -->
  <p-dialog 
    header="Ubicación del Almacén" 
    [(visible)]="displayMapDialog" 
    [style]="{width: '90vw', maxWidth: '800px'}"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
  >
    <div class="map-dialog-content" *ngIf="warehouseSelected">
      <app-map [warehouse]="warehouseSelected"></app-map>
    </div>
    <ng-template pTemplate="footer">
      <app-button 
        (click)="displayMapDialog = false" 
        theme="primary"
        fontSize="font-md"
      >
        Cerrar
      </app-button>
    </ng-template>
  </p-dialog>
</div>
