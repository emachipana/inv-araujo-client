<div class="flex-column container">
  <div class="flex-row">
    <div 
      class="flex-row cursor-pointer nav-item"
      [ngClass]="{'active': currentTab === 'varieties'}"
      (click)="changeTab('varieties')"
    >
      <div class="item flex-row" [ngClass]="{'active': currentTab === 'varieties'}">1</div>
      <p class="name">VARIEDADES</p>
    </div>
    <mat-icon class="taupe" style="font-weight: 800;">chevron_right</mat-icon>
    <div 
      class="flex-row cursor-pointer nav-item"
      [ngClass]="{'active': currentTab === 'checkout'}"
      (click)="changeTab('checkout')"
    >
      <div class="item flex-row" [ngClass]="{'active': currentTab === 'checkout'}">2</div>
      <p class="name">DETALLES DEL PEDIDO</p>
    </div>
    <mat-icon class="taupe" style="font-weight: 800;">chevron_right</mat-icon>
    <div 
      class="flex-row cursor-pointer nav-item"
      [ngClass]="{'active': currentTab === 'success'}"
    >
      <div class="item flex-row" [ngClass]="{'active': currentTab === 'success'}">3</div>
      <p class="name">PEDIDO COMPLETADO</p>
    </div>
  </div>
  @if (currentTab === 'varieties') {
    <section class="select-varieties border-type1">
      <div 
        class="flex-column"
        style="gap: 0.1rem"
      >
        <h3 class="title">Selecciona las variedades</h3>
        <p class="text">Elige las plántulas que deseas incluir en tu pedido</p>
      </div>
      <div 
        class="flex-row"
        style="width: 100%; gap: 1rem; flex-wrap: wrap; justify-content: space-around;"
      >
        @if(isLoading) {
          <spinner size="md" />
        }@else {
          @for (variety of _invitroService.varieties(); track $index) {
            <app-variety 
              [variety]="{id: variety.id, quantity: 500, variety: variety}"
              [isSelected]="varietyIsSelected(variety)"
              (onClick)="onClickCard($event)"
            />
          }
        }
      </div>
      <div 
        class="flex-row"
        style="width: 100%; justify-content: flex-end;"
      >
        <app-button
          theme="secondary"
          icon="event_note"
          fontSize="font-md"
          (onClick)="changeTab('checkout')"
        >
          Continuar
        </app-button>
      </div>
    </section>
  }@else if(currentTab === 'checkout') {
    <section class="main-section">
      <section class="checkout">
        <section 
          class="select-varieties border-type1"
          style="width: 100%; gap: 1rem;"
        >
          <div 
            class="flex-column"
            style="gap: 0.1rem"
          >
            <h3 class="title">Ajusta las cantidades</h3>
            <p class="text">Define cuántas plántulas necesitas de cada variedad</p>
          </div>
          <div class="info">
            <p class="info-text">
              Nuestra capacidad de producción es de 8000 plántulas al mes, para tu pedido ({{ totalPlants }} plántulas)
              necesitaremos almenos {{ months }} {{ months > 1 ? 'meses' : 'mes' }}
            </p>
          </div>
          <div 
            class="flex-column"
            style="width: 100%; gap: 0.7rem; margin-bottom: 1rem;"
          >
            @for (variety of varietiesSelected.value; track $index) {
              <app-order-variety 
                [variety]="variety"
              />
            }
          </div>
          <custom-input
            type="date"
            id="date"
            [min]="minDate"
            label="Elige para que fecha necesitas el pedido"
            placeholder="Seleccione una fecha"
            [isDisabled]="!varietiesSelected.value.length"
            (change)="onDateChange($event)"
          />
        </section>
      </section>
      <section 
        class="payment"
        style="position: sticky;" [ngStyle]="{'top': _dataService.isInfoNavbarVisible ? '160px' : '130px'}"
      >
        <div class="order flex-column border-type1">
          <h5 class="order-title">RESUMEN DE TU PEDIDO</h5>
          <div
            class="flex-column"
            style="gap: 0.25rem; width: 100%;"
          >
            <div class="flex-row full-row">
              <p class="header-title">TOTAL</p>
              <p class="order-text">{{totalAmount | currency: 'S/.'}}</p>
            </div>
            <div class="flex-row full-row">
              <p class="header-title">ADELANTO (50%)</p>
              <p class="discount-price">{{totalAmount / 2 | currency: 'S/.'}}</p>
            </div>
            <hr class="line" />
            <div class="flex-row full-row">
              <p class="header-title">IGV (18%)</p>
              <p class="order-text">{{((totalAmount / 2) - totalWithoutIgv) | currency: 'S/.'}}</p>
            </div>
            <div class="flex-row full-row">
              <p class="header-title">SUBTOTAL</p>
              <p class="order-text">{{totalWithoutIgv | currency: 'S/.'}}</p>
            </div>
          </div>
          <hr class="line" />
          <app-button
            fontSize="font-xl"
            [fullSize]="true"
            [isDisabled]="!orderDate || isLoadingOrder"
            (onClick)="generateOrder()"
            [isLoading]="isLoadingOrder"
          >
            Hacer pedido
          </app-button>
        </div>
      </section>
    </section>
  }@else if(currentTab === 'success') {
    <div class="success-card border-type1">
      <div class="success-icon">
        <span class="material-icons">check_circle</span>
      </div>
      <h2 class="success-title">¡Pedido Confirmado!</h2>
      <p class="success-message">Tu pedido se ha generado correctamente</p>
      
      <div class="delivery-info flex-column">
        <div class="flex-row info-item">
          <span class="material-icons">local_shipping</span>
          <p>Entrega en 1-3 días hábiles</p>
        </div>
        <div class="flex-row info-item">
          <span class="material-icons">
            visibility
          </span>
          <p>
            Revisa el detalle de tu pedido en nuestra plataforma
          </p>
        </div>
      </div>
      <div class="flex-row">
        <app-button
          [icon]="'visibility'"
          fontSize="font-xl"
          (onClick)="onOrderDetail()"
        >
          Ver detalle
        </app-button>
        <app-button 
          (onClick)="router.navigate(['/tienda'])"
          fontSize="font-xl"
          theme="secondary"
        >
          Seguir comprando
        </app-button>
      </div>
    </div>
  }
</div>
